{% extends "base.html" %}
{% block title %}Set Budget{% endblock %}

{% block content %}
<div class="auth-container">
  <h2>ðŸ“Š Set Monthly Budgets</h2>

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <ul class="flash-messages">
        {% for category, message in messages %}
          <li class="flash-{{ category }}">{{ message }}</li>
        {% endfor %}
      </ul>
    {% endif %}
  {% endwith %}

  <form method="POST" action="{{ url_for('finance.set_budget') }}" class="auth-form">
    <input type="text" name="category" placeholder="Category" required>
    <input type="number" name="limit" placeholder="Monthly Limit (â‚¹)" step="0.01" required>
    <button class="auth-btn" type="submit">Set Budget</button>
  </form>
</div>

<div class="auth-container" style="margin-top: 40px;">
  <h2>ðŸ§¾ Your Budgets with Usage</h2>

  {% if budgets %}
    <div class="table-wrapper">
      <table class="styled-table">
        <thead>
          <tr>
            <th>Category</th>
            <th>Limit (â‚¹)</th>
            <th>Spent (â‚¹)</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody>
          {% for budget in budgets %}
            {% set spent = 0 %}
            {% for t in budget.user.transactions %}
              {% if t.category == budget.category and t.type == 'expense' and t.date.strftime('%Y-%m') == now.strftime('%Y-%m') %}
                {% set spent = spent + t.amount %}
              {% endif %}
            {% endfor %}
            {% set percent = (spent / budget.limit_amount) * 100 if budget.limit_amount > 0 else 0 %}
            <tr>
              <td>{{ budget.category }}</td>
              <td>â‚¹{{ "%.2f"|format(budget.limit_amount) }}</td>
              <td>â‚¹{{ "%.2f"|format(spent) }}</td>
              <td>
                <div class="progress-bar-container">
                  <div class="progress-bar
                    {% if percent > 100 %} progress-danger
                    {% elif percent > 75 %} progress-warning
                    {% endif %}"
                    style="width: {{ percent if percent <= 100 else 100 }}%;">
                    {{ "%.0f"|format(percent) }}%
                  </div>
                </div>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% else %}
    <p>No budgets set yet.</p>
  {% endif %}

  <a class="btn-link" style="margin-top: 20px;" href="{{ url_for('dashboard') }}">â¬… Back to Dashboard</a>
</div>
{% endblock %}
